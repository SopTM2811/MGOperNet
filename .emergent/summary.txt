<analysis>**original_problem_statement:**
El usuario ha solicitado la creación y refinamiento de una aplicación full-stack (Asistente NetCash MBco) para gestionar un flujo financiero. La filosofía principal, y más crítica, es que el sistema debe actuar como un **FILTRO ESTRICTO**. No se debe crear ninguna operación NetCash (ni por email ni por Telegram) a menos que se cumplan **TODAS** las siguientes condiciones de validación:
1.  **Cliente Válido**: El remitente (por email o Telegram) debe ser un cliente con estado activo.
2.  **Comprobante Válido**: Debe haber al menos un adjunto (PDF/JPG/PNG) que, mediante OCR, se verifique que corresponde a la **cuenta de depósito activa** configurada en el sistema (verificando CLABE y beneficiario).
3.  **Nombre de Beneficiario Válido**: El texto debe contener un nombre con un mínimo de 3 palabras (nombre + dos apellidos), sin números.
4.  **IDMEX Válido**: Debe contener un identificador de exactamente 10 dígitos numéricos.
5.  **Cantidad de Ligas Válida**: Debe contener un número entero > 0 asociado a palabras clave como ligas o líneas de captura.

Si alguna de estas reglas falla, el sistema **NO CREA** la operación y debe responder al usuario explicando exactamente qué campo es incorrecto o falta, guiándolo para corregirlo.

**User's preferred language**: español

**what currently exists?**
La aplicación es una PWA full-stack con frontend en React y backend en FastAPI, usando MongoDB. Los componentes principales son:
*   Un bot de Telegram () para interactuar con clientes.
*   Un monitor de correos () que procesa solicitudes enviadas a .
*   Un panel web para la administración de operaciones y clientes.
*   Un módulo centralizado para gestionar la cuenta de depósito activa ().
*   Un servicio de validación de comprobantes () que usa OCR () para leer PDFs e imágenes.

El agente ha estado trabajando en implementar las reglas duras descritas, refactorizando el código para que tanto el email como Telegram las apliquen de forma consistente, eliminando cuentas hardcodeadas y mejorando la inteligencia del parser y la claridad de las respuestas de error.

**Last working item**:
El agente estaba en medio de una refactorización mayor para implementar las reglas duras del usuario y corregir varios bugs críticos reportados.

-   **Last item agent was working**:
    1.  Corrigiendo un bug crítico en  donde el endpoint de validación de comprobantes, usado por Telegram, comparaba contra una cuenta hardcodeada en lugar de la cuenta activa del sistema.
    2.  Refactorizando  para mejorar el parser (para que extraiga datos como el nombre de una frase completa) y para implementar el nuevo formato de respuesta detallado (Esto es lo que entendí con un status ✅/❌ por cada campo).
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: both
    *   **Backend Testing Agent**: Para crear una suite de tests que verifique las reglas duras en ambos canales. Debe simular envíos con datos correctos, incorrectos y mezclados para asegurar que las operaciones solo se crean cuando todo es válido. Es crucial probar el validador de OCR con comprobantes de diferentes cuentas (activas e inactivas).
    *   **Frontend Testing Agent**: Para validar el flujo de Telegram (respuesta a saludos, validación de comprobantes) y los cambios en la UI web (ocultar operaciones marcadas como inválidas).
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1 (P0)**: Telegram valida comprobantes contra una cuenta incorrecta/hardcodeada.
-   **Issue 2 (P0)**: El parser de email no interpreta correctamente los datos cuando vienen en una frase.
-   **Issue 3 (P0)**: El bot de Telegram no responde a saludos como Hola.
-   **Issue 4 (P1)**: Las respuestas de error por email no son suficientemente específicas.
-   **Issue 5 (P2)**: Operaciones inválidas antiguas siguen visibles en el panel web.

**Issues Detail:**
-   **Issue 1: Telegram valida comprobantes contra una cuenta incorrecta/hardcodeada.**
    -   **Attempted fixes**: El agente identificó que el endpoint  en  usaba una cuenta hardcodeada. Reemplazó este valor por una llamada a .
    -   **Next debug checklist**:
        1.  Revisar  para asegurar que está llamando al endpoint correcto y manejando la respuesta de validación ().
        2.  Si la validación es falsa, el bot debe detener el flujo, no crear la operación y enviar el mensaje de error correspondiente.
        3.  Realizar una prueba end-to-end: configurar una cuenta activa A, enviar por Telegram un comprobante de una cuenta inactiva B y verificar que el bot lo rechace correctamente.
    -   **Why fix this issue and what will be achieved with the fix?**: Es el bug más crítico. Permite crear operaciones con pagos inválidos, rompiendo la lógica de negocio fundamental.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Both.
    -   **Blocked on other issue**: No.

-   **Issue 2: El parser de email no interpreta correctamente los datos cuando vienen en una frase.**
    -   **Attempted fixes**: El agente comenzó a refactorizar  para usar expresiones regulares más flexibles y poder extraer subcadenas (como el nombre del beneficiario) de una frase completa.
    -   **Next debug checklist**:
        1.  Finalizar la implementación del nuevo parser en .
        2.  Probar con el caso de uso del usuario (NETCASH SPEED con todos los datos en una línea).
        3.  Verificar que la respuesta por email refleje que el nombre, IDMEX y ligas fueron detectados como válidos.
    -   **Why fix this issue and what will be achieved with the fix?**: Mejora la usabilidad del canal de correo al entender un lenguaje más natural.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Backend.
    -   **Blocked on other issue**: No.

-   **Issue 3: El bot de Telegram no responde a saludos como Hola.**
    -   **Attempted fixes**: El agente añadió una función  y un  con un patrón regex en . Corrigió un error de sintaxis en el regex que impedía que el bot iniciara.
    -   **Next debug checklist**:
        1.  Verificar que el  de saludos está registrado **antes** del handler genérico de mensaje no reconocido.
        2.  Probar enviando Hola, buen día, etc., tanto al inicio como en medio de una conversación, para asegurar que el bot responde con el menú principal.
    -   **Why fix this issue and what will be achieved with the fix?**: Mejora la experiencia de usuario, haciendo el bot más amigable y accesible.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend.
    -   **Blocked on other issue**: No.

-   **Issue 4: Las respuestas de error por email no son suficientemente específicas.**
    -   **Attempted fixes**: El agente refactorizó la función de respuesta en  para construir un mensaje con el formato Esto es lo que entendí, que muestra un ✅ o ❌ para cada campo.
    -   **Next debug checklist**: Conectar el resultado del nuevo parser (Issue 2) con esta función de respuesta. Probar enviando correos con diferentes combinaciones de errores (IDMEX corto, nombre con 2 palabras, etc.) y verificar que el email de respuesta liste correctamente solo los errores.
    -   **Why fix this issue and what will be achieved with the fix?**: Es un pilar de la nueva filosofía. Guía al cliente de forma efectiva para que corrija su solicitud.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Backend.
    -   **Blocked on other issue**: Issue 2.

-   **Issue 5: Operaciones inválidas antiguas siguen visibles en el panel web.**
    -   **Attempted fixes**: El agente creó un script para marcar operaciones antiguas con  en la base de datos.
    -   **Next debug checklist**:
        1.  Modificar el endpoint de backend () para que por defecto filtre y no devuelva las operaciones con .
        2.  Modificar el componente de frontend (ej. ) que muestra la tabla de operaciones para que no las renderice.
    -   **Why fix this issue and what will be achieved with the fix?**: Limpia el panel de operaciones de ruido, permitiendo que el equipo se enfoque solo en operaciones válidas.
    -   **Status**: NOT STARTED (solo se hizo el cambio en BD).
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Both.
    -   **Blocked on other issue**: No.

**In progress Task List**:
- N/A

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P2) Corregir el monitor de inactividad para que cancele operaciones correctamente ().
    -   (P3) Finalizar el modo espejo en el frontend (solo lectura para operaciones de Telegram).
    -   (P3) Implementar los filtros de búsqueda en el listado de operaciones y clientes.
-   **Future Tasks**:
    -   Implementar el módulo de Comunicados para Ana.
    -   Implementar el módulo de control diario para Claudia.
    -   Implementar los reportes para la Dirección.

**Completed work in this session**
-   **Corrección de bug crítico**: Se corrigió el endpoint  en  para que use la cuenta de depósito activa en lugar de una hardcodeada.
-   **Refactorización del monitor de email**: Se inició la reescritura de  para implementar un parser más inteligente y el formato de respuesta de error específico Esto es lo que entendí.
-   **Mejora del validador de comprobantes**: Se actualizó  para que el OCR sea más flexible al buscar la razón social y la CLABE.
-   **Mejora del bot de Telegram**: Se añadió un handler para responder a saludos (Hola) y se eliminaron cuentas hardcodeadas de los mensajes del bot. Se corrigió un error de sintaxis que impedía que el bot se iniciara.
-   **Limpieza de datos**: Se crearon y ejecutaron scripts para marcar operaciones antiguas e inválidas en la base de datos con .
-   **Mejora de UI**: Se agregó un botón de Volver al menú principal en la página de alta de Telegram ().

**Earlier issues found/mentioned but not fixed**
-   Los problemas mencionados en resúmenes anteriores han sido reemplazados por la nueva lista de reglas duras y bugs del usuario, que son la prioridad actual.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Uso de valores hardcodeados en lugar de configuraciones dinámicas de la base de datos (Ej: cuentas de depósito).
-   **Recurrence count**: Alto.
-   **Status**: IN PROGRESS. El agente corrigió varias instancias, pero el problema reapareció en el endpoint de validación de comprobantes, demostrando que es un riesgo recurrente.

**Code Architecture**


**Key Technical Concepts**
-   **Backend**: FastAPI, ,  (MongoDB async).
-   **Frontend**: React.js, .
-   **Base de datos**: MongoDB.
-   **Integraciones**: Gmail API,  para OCR, .
-   **Core Logic**: La nueva filosofía de filtro estricto donde no se crean operaciones hasta que todos los datos son 100% válidos.

**key DB schema**
-   **operaciones**:  (campo nuevo/modificado).
-   **config_cuenta_deposito_netcash**: . Es la única fuente de verdad para la cuenta de depósito.
-   **clientes**: .
-   **usuarios_telegram**: .

**changes in tech stack**
-   Se añadieron y configuraron las dependencias para OCR:  y  (vía ).

**All files**
-   **/app/backend/server.py**: Modificado para eliminar una cuenta hardcodeada en el endpoint de validación de comprobantes y usar el servicio de cuenta activa.
-   **/app/backend/email_monitor.py**: Refactorizado extensivamente para implementar las reglas duras, mejorar el parser y el formato de las respuestas de error.
-   **/app/backend/telegram_bot.py**: Modificado para añadir un handler de saludos, eliminar todas las cuentas hardcodeadas y prepararlo para la validación estricta de comprobantes.
-   **/app/backend/validador_comprobantes_service.py**: Actualizado para mejorar la lógica de OCR y hacerla más tolerante a formatos de comprobantes reales.
-   **/app/frontend/src/pages/AltaClienteTelegram.jsx**: Modificado para añadir un botón de regreso al menú principal.

**Critical Info for New Agent**
-   **FILOSOFÍA DE FILTRO ESTRICTO**: Este es el cambio más importante. NO se deben crear operaciones (ni en la BD, ni generar un folio NC-XXXX) si alguna de las 5 reglas duras (cliente, nombre, idmex, ligas, comprobante) falla. El sistema solo debe guiar al usuario para que corrija la información. Elimina cualquier lógica que cree operaciones incompletas.
-   **CUENTA ACTIVA CENTRALIZADA**: Toda validación y muestra de la cuenta de depósito (en email, Telegram, web) debe usar **exclusivamente** . No debe existir ningún hardcode de CLABE, banco o beneficiario en ninguna parte del código.
-   **VALIDACIÓN DE COMPROBANTES**: La validación de comprobantes es idéntica para email y Telegram y debe usar , pasándole la cuenta activa. El bug más reciente fue que Telegram no lo hacía.

**Last 5 User Messages and any pending user messages**
-   **msg 269**: Es el mensaje más importante. Proporciona una lista exhaustiva de reglas duras, bugs concretos y criterios de aceptación. Reporta el bug crítico de Telegram validando comprobantes contra una cuenta incorrecta y el fallo del parser de email con frases. **Estado: IN PROGRESS.**
-   **msg 218**: Versión anterior del mismo requerimiento, ahora superado por el mensaje 269 que tiene más contexto y detalles de los bugs encontrados.
-   **msg 193, 152**: Mensajes anteriores que construyeron la idea de las reglas duras, ahora consolidados y detallados en el mensaje 269.
-   **msg 107**: Requerimiento anterior donde se reportó por primera vez que la cuenta de depósito en el email seguía hardcodeada, lo que llevó a la creación del módulo de cuenta centralizado.

**Project Health Check:**
-   **Broken**: La validación de comprobantes en Telegram es incorrecta, ya que no utiliza la cuenta activa, lo que constituye un fallo crítico de la lógica de negocio.
-   **Mocked**: N/A
-   **Working but pending verification**: La corrección al endpoint del backend, el nuevo handler de saludos de Telegram y el nuevo parser/formato de respuesta del monitor de email.

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: []
-   **Known regressions**: El flujo de validación de comprobantes en Telegram es una regresión, ya que ignora el módulo de cuenta activa centralizado.

**What agent forgot to execute**
-   El agente aún no ha modificado el frontend para ocultar las operaciones marcadas como .
-   Aunque se corrigió el endpoint del backend, la lógica completa dentro de  para manejar la respuesta de validación () y detener el flujo no ha sido completamente implementada ni verificada.</analysis>
